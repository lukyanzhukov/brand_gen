import { generateJsonContent } from './llm-server'
import { ColorPalette, FALLBACK_PALETTE } from './palette'

/**
 * Генерирует цветовую палитру на основе текста вакансий и логотипа (серверная версия)
 */
export async function generatePalette(vacancyCorpus: string, logoUrl?: string): Promise<ColorPalette> {
  const systemPrompt = `Ты - эксперт по цветовому дизайну и брендингу. Твоя задача - создать гармоничную цветовую палитру для бренд-страницы работодателя.

СЛЕДУЙ ГАЙДЛАЙНУ НАПОЛНЕНИЯ КОМПОНЕНТОВ:

## АНАЛИЗ ЛОГОТИПА
- **ОБЯЗАТЕЛЬНО анализируй логотип** для выбора основных цветов
- **Избегай стандартных синих палитр**, если логотип не синий
- **Извлекай доминирующие цвета** из логотипа
- **Создавай гармоничные сочетания** на основе логотипа

## ПСИХОЛОГИЯ ЦВЕТОВ
- **Зеленые**: рост, инновации, экология, стабильность
- **Фиолетовые**: креативность, технологии, премиальность, инновации
- **Оранжевые**: энергия, динамика, дружелюбность, активность
- **Красные**: лидерство, амбиции, результат, страсть
- **Синие**: надежность, профессионализм, технологии (только если логотип синий)
- **Серые**: нейтральность, профессионализм, элегантность

## ПРИНЦИПЫ ДИЗАЙНА
- **Современные и профессиональные** цвета
- **Высокий контраст** для читаемости
- **Эмоционально подходящие** для IT-компании
- **Гармоничные сочетания** цветов
- **Доступность** для людей с нарушениями зрения

## КРИТИЧЕСКИ ВАЖНО
1. **Анализируй логотип** перед выбором цветов
2. **Избегай стандартных синих** палитр без анализа
3. **Создавай эмоционально подходящие** цвета
4. **Используй современные** цветовые тренды
5. **Обеспечивай высокий контраст** для читаемости

## ЦВЕТОВЫЕ СЕМЬИ
- **Теплые**: #FF6B35, #F7931E, #FFD23F, #06FFA5, #118AB2
- **Природные**: #2D5016, #4A7C59, #7BA05B, #9ACD32, #ADFF2F
- **Креативные**: #6A4C93, #C44569, #F8B500, #FF6B6B, #4ECDC4
- **Профессиональные**: #1E3A8A, #3B82F6, #06B6D4, #10B981, #F59E0B
- **Элегантные**: #374151, #6B7280, #9CA3AF, #D1D5DB, #F3F4F6

## СТРУКТУРА ПАЛИТРЫ
- **primary**: основной цвет (из логотипа или гармонирующий)
- **onPrimary**: контрастный к primary
- **secondary**: дополнительный цвет
- **onSecondary**: контрастный к secondary
- **background**: светлый фон
- **surface**: поверхность
- **onBackground**: основной текст
- **onSurface**: вторичный текст
- **accent**: акцентный цвет
- **onAccent**: контрастный к accent
- **error**: цвет ошибок
- **onError**: контрастный к error
- **outline**: границы

## БЛОЧНЫЕ ЦВЕТА
- **hero**: яркий, привлекательный, с градиентами
- **about**: профессиональный, доверительный
- **tracks**: технологичный, современный
- **geo**: нейтральный, информативный
- **facts**: контрастный, читаемый
- **benefits**: теплый, дружелюбный
- **culture**: вдохновляющий, живой
- **media**: динамичный, яркий
- **hiring**: четкий, структурированный
- **cta**: призывный, яркий

Верни объект с hex-цветами. Все цвета должны гармонично сочетаться и отражать характер компании.`

  const userPrompt = `Текст вакансий для анализа тона и стиля:
${vacancyCorpus}

${logoUrl ? `Логотип компании: ${logoUrl}
Проанализируй цвета логотипа и создай палитру, которая гармонирует с ним.` : ''}

Подбери палитру, которая отражает характер компании и вакансий.`

  try {
    const palette = await generateJsonContent(systemPrompt, userPrompt, FALLBACK_PALETTE)
    
    // Валидация цветов
    if (isValidPalette(palette)) {
      return palette
    }
  } catch (error) {
    console.error('Error generating palette:', error)
  }

  return FALLBACK_PALETTE
}

/**
 * Проверяет валидность палитры
 */
function isValidPalette(palette: any): palette is ColorPalette {
  const requiredFields = [
    'primary', 'onPrimary', 'secondary', 'onSecondary',
    'background', 'surface', 'onBackground', 'onSurface',
    'accent', 'onAccent', 'error', 'onError', 'outline'
  ]
  
  return requiredFields.every(field => 
    palette && 
    typeof palette[field] === 'string' && 
    palette[field].startsWith('#')
  )
}
